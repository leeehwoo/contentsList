<!DOCTYPE html>

<html lang="en">
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
      <meta http-equiv="Pragma" content="no-cache">
      <meta charset="UTF-8">
      <title>Soda Beta Makeup</title>
      <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
      <script type="text/javascript" src="/static/jquery.qrcode.js"></script>
      <script type="text/javascript" src="/static/qrcode.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
      <style>
          .style_group
            {
                display: flex;
                min-width: 1600px;
                flex-wrap: wrap;
            }
            .style_group img
            {
                height: 100px;
                width: auto;
            }
            .img p {
                text-align: center;
                width: 100px;
                height: 100px;
                line-height: 100px;
            }

            .content-main > div {
                display: flex;
                align-items: center;
                border-top: 3px dotted #ccc;
                padding: 50px 0;
            }

            .c_name {
                padding: 0 30px;
            }

            .style_block {
                margin-bottom: 30px;
                width: 100px;
                height: 130px;
                margin-right: 30px;
            }

            .style_block img {
                width: 100%;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
            }

            .style_name {
                width: 100%;
                height: 30px;
                color: #fff;
                background-color: #333;
                font-size: 12px;
                line-height: 30px;
                text-align: center;
                border-bottom-left-radius: 10px;
                border-bottom-right-radius: 10px;
            }

            .img img {
                width: 100px;
                height: 100px;
                object-fit: cover;
            }

            .chk .style-id{
                font-size: 22px;
                font-weight: bold;
            }

      </style>
   </head>

   <body>
   <h1>Makeup (SODA BETA)</h1>
   <div>
       <br>
<body>
    <!-- body 부분 -->
    Search : id/name 검색어 입력
    <input id="searchInput">
</body>

       <br>
       <br>
       <!-- <select id="select_app_type">
           <option value="soda_real" selected>soda real</option>
           <option value="soda_beta">soda beta</option>
           <option value="tianyan_real">tianyan real</option>
           <option value="tianyan_beta">tainyan beta</option>
       </select> -->
       <br>
       <br>
   </div>
      <div class="content-main">

        </div>
<!-- Bootstrap의 JavaScript 모달 플러그인을 사용하여 팝업창을 만든다.
https://getbootstrap.com/docs/4.0/components/modal/ 의 예제소스코드 참고 -->

        <div class="modal fade" id="exampleModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Makeup Information</h5>
        <!-- modal 구동 버튼 (trigger) -->
        <button type="button" class="close cl" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body style_info">
            <div id="modal-style-id"></div>
          <!-- div 요소는 "순수" 컨테이너로서 아무것도 표현하지 않는다, 대신 다른 요소 여럿을 묶어 class나 id 속성으로 꾸미기 쉽도록 한다.
          아래의 qrcode2 modal style id 밑에 와야 함, 그래야 팝업 아래에 QR코드가 나온다.-->
          <div class="qrcode2"></div>
      </div>
      <div class="modal-footer">
          <button type="button" class="btn btn-secondary dl" id="dl">QR download</button>
        <button type="button" class="btn btn-secondary modal-close cl" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


   </body>
    <script>
<!-- const {info} 를 사용, main_url을 style_info로 접근할 수 있도록 한다.-->
        const style_infos = {
            main_url:"soda://go",
            app_type:"soda_real",
        }
        const style_json_info = {

        }

<!--ajax_.py의 call style api -->
    </script>
<script>
    var num = '';
    $(function (){

        // $("#select_app_type").change(function () {
        //     style_infos.app_type = $(this).val();
        //     if (style_infos.app_type === "soda_real")
        //     {
        //         style_infos.main_url = "soda://go";
        //     }
        //     else if (style_infos.app_type === "soda_beta")
        //     {
        //         style_infos.main_url = "sodab://go";
        //     }
        //     else if (style_infos.app_type === "tianyan_real")
        //     {
        //         style_infos.main_url = "tianyan://go";
        //     }
        //     else if (style_infos.app_type === "tianyan_beta")
        //     {
        //         style_infos.main_url = "tianyanb://go";
        //     }
        //     call_style_api();
        // })

        call_style_api();
        $(document) // api가 로딩이 되면
        .on("click", ".cl" , function (){
            $("canvas").remove(); // popup close했을 때 초기화되도록 한다. canvas(큐알코드) 삭제
        })

           // 다운로드 버튼 클릭
        .on("click", ".dl", function (e){

            // canvas 지정
            var can = $("canvas")[0];
            // 이미지 링크 PNG로 생성
            var QR = can.toDataURL('image/png');
            // aTag 생성
            var aTag = document.createElement("a");
            console.log(num);
           // 다운로드시 이름
            aTag.download = num+'.png'
            // 위에 링크 생성해준걸 등록
            aTag.href = QR
            // aTag을 클릭하여 다운로드
            aTag.click();
        })// 키보드 esc 버튼 눌렀을 때 초기화
        .keyup(function (e){
            if(e.keyCode == 27){
                $("canvas").remove();
            }
            console.log(e.keyCode);
        })
    })




    function click_style_info(th)
    {
        console.log($(th));
        $("#modal-style-id").empty(); // .empty()는 선택한 요소의 내용을 지운다. 내용만 지울 뿐 태그는 남아있다.
        var cid = $(th).data("categoryid");
        var iid = $(th).data("itemid");
        var s_id = 'sodab://go?tab=makeup&categoryid=' + cid+"&itemid="+iid;
        var style_json = $(th).find(".style_json").clone();
        $("#modal-style-id").append(`<div>${s_id}</div>`);
        $("#modal-style-id").append(style_json);
        num = $(th).find('.style-id').text();
        console.log(num);





// s_id(Line 80)을 qr code로 생성
$(".qrcode2").qrcode({
        id:"qr",
      render: "canvas",
      width: 100,
      height: 100,
      text: (s_id)

      });

    }

// append를 해주는 부분.(jQuery append with api call)
// 아래의 부분은 결과 성공 call back 함수인데, request가 완료되었을 때, 시작하는 부분이다.

function call_style_api() {

    $.ajax({
        url: "/ajax/api/style?appType=makeup_beta",
        success: function (result) {
            $(".content-main").empty();
            // 통신이 성공적으로 이루어졌을 때 이 함수를 타게 된다.  TO-DO
            console.log("result");
            console.log(result.result);
            // console.log(result.result); // result라는 객체로 보냈기 때문에 result로 결과가 온다.
            // 처음에 그룹(카테고리)를 뽑고 있다.
            for (var i = 0; i < result.result.categories.length; i++) {
                const gid = result.result.categories[i].id;
                const gtitle = result.result.categories[i].title;
                const chk = result.result.categories[i].subType;
                let sub_html = ''
                // 여기서부터는 하나의 그룹에, styleID 많이 가지고 있는 것 가지고 오려는 부분을 for문으로 돌린다.
                // 여기서 체크할 것 : style들은 따로 오는데, 그 style들을 다시 조회하긴 해야 된다.
                // 만약 A카테고리에 스타일이 30개, B카테고리에 스타일이 20개 이렇게 있다고 해도..그룹이 한꺼번에 오니까 그거에 대해서는 조회를 다 해야 된다.

                if(chk != "MAKEUP_SUB"){

                    for (var j = 0; j < result.result.categories[i].assetIds.length; j++) {
                        for (var k = 0; k < result.result.assets.length; k++) {
                             // 그래서 if로 그것들을 다 찾는다.
                            if(result.result.categories[i].assetIds[j] == result.result.assets[k].id){
                            console.log(result.result.assets[k])
                            const style_id = result.result.assets[k].id;
                            const style_name = result.result.assets[k].name;

                             // 해당 파라미터 안에 값을 넣고, make url을 한다.
                                // 그러고 나서 계속 이 html부분을 누적을 해 준다.
                            // 이 작업이 끝나면 하나의 group에 있는 모든 styleID들을 다 찾은 것이다.
                                const style_thumb = result.result.cdnPrefix +"/sticker/asset/" + style_id+ "/"+result.result.assets[k].thumbnail;
                                style_json_info[style_id] = {"style_id":style_id, "style_name":style_name};
                                sub_html += `<div class="style_block img c${style_id} c${style_name}" data-toggle="modal" data-target="#exampleModal" data-categoryid="${gid}" data-itemid="${style_id}" onclick="click_style_info($(this))"><div class="style-id">${style_id}</div>


                                        <img src="${style_thumb}" onerror="this.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/1024px-No_image_available.svg.png'"></img>
                                        <div class="style_name">${style_name}</div>
                                        <div class="hide_view_json" style="display: none">
                                            <div class="style_json">
                                            <div class="id" data-id="${style_id}">makeup_id : ${style_id}</div>
                                            <div>makeup_name : ${style_name}</div>

                                        </div>

                                        </div>

                                        </div>`;
                            }
                            }
                        }
                        const html = `
                <div className="contentsListContainer" class="c_box">
                    <div className="categoryNameColumn" class="c_name">
                        <h2>${gid}</h2> <p>${gtitle}</p>
                    </div>
                      <div class="style_group">
                        ${sub_html}
                        </div>
                </div>`
                    $(".content-main").append(html);
                    }


                }

            $(".style_block").click(function () {
                if ($(this).hasClass('clicked')) {
                    $(this).removeClass('clicked');

                } else {

                    $(".style_block").removeClass('clicked');
                    $(this).addClass('clicked');
                    var a = $(this).find('div')[0];
                }
            });
        },
        error: function (e) {
            console.error(e);
        }
    })
}


   $(function(){
      $(document)
      .on("keyup"  , function(e){
         var c = $("#searchInput").val();
        $(".style_block").removeClass("chk");
        $(".c"+c).addClass("chk");
      })


   })

</script>
</html>